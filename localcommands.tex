% By LSP.
\renewbibmacro*{index:name}[5]{%
  \usebibmacro{index:entry}{#1}
    {\iffieldundef{usera}{}{\thefield{usera}\actualoperator}\mkbibindexname{#2}{#3}{#4}{#5}}}


% By LSP.
\makeatletter
\def\blx@maxline{77}
\makeatother


% Fix line spacing in list environmens.
\setlist{noitemsep}


% Correct hyperref colors which otherwise give you eye cancer.
\hypersetup{
  linkbordercolor  = {white}
  , linkcolor        = {lsMidDarkBlue}
  , anchorcolor      = {lsMidWine}
  , citecolor        = {lsDarkGreenOne}
  , menucolor        = {lsMidDarkBlue}
  , urlcolor         = {lsDarkOrange}
%    , filecolor       = {}
%    , runcolor        = {}
}


% Use a better mono font, ideal for code.
% https://github.com/chrissimpkins/codeface/tree/master/fonts/inconsolata-g
\setmonofont{Inconsolata-g}


% Use a math font that actually works! Requires unicode-math paackage.
% https://github.com/khaledhosny/libertinus
\setmathfont[Scale=MatchUppercase]{libertinusmath-regular.otf}


\newenvironment{listLileveli}{\begin{enumerate}}{\end{enumerate}}
\newenvironment{listLilevelii}{\begin{enumerate}}{\end{enumerate}}
\newenvironment{listLileveliii}{\begin{enumerate}}{\end{enumerate}}
\newenvironment{listLileveliv}{\begin{enumerate}}{\end{enumerate}}
\newenvironment{listLiileveli}{\begin{itemize}}{\end{itemize}}
\newenvironment{listLiilevelii}{\begin{itemize}}{\end{itemize}}
\newenvironment{listLiileveliii}{\begin{itemize}}{\end{itemize}}
\newenvironment{listLiileveliv}{\begin{itemize}}{\end{itemize}} 

% define own variables for hacks
\newlength{\myBuffer}

% formatting
\newcommand{\Lf}{
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}

% Feinsatz 

\newcommand{\Stretch}[1][1]{\vspace{#1\baselineskip}}
\newcommand{\Unstretch}[1][0.5]{\vspace{-#1\baselineskip}}
\newcommand{\Hardstretch}[1][1]{\vspace*{#1\baselineskip}}
\newcommand{\Enl}[1][1]{\enlargethispage{#1\baselineskip}}
\newcommand{\Np}{\newpage}

% Uncomment to switch off
%\renewcommand{\Stretch}[1][1]{}
%\renewcommand{\Unstretch}[1][0.5]{}
%\renewcommand{\Hardstretch}[1][1]{}
%\renewcommand{\Enl}[1][1]{}
%\renewcommand{\Np}{}


% all sorts of shortcuts
\newcommand{\HStrut}[1]{\rule{0pt}{#1pt}}
\newcommand{\VStrut}[1]{\rule{#1pt}{0pt}}
\newcommand{\Sw}[1]{\begin{sideways}#1\end{sideways}}
\newcommand{\Ast}{*}
\definecolor{lg}{rgb}{.8,.8,.8}
\newcommand{\Dim}{\cellcolor{lg}}
\newcommand{\Tidx}[1]{\ensuremath{_{\mathnormal{#1}}}}
\newcommand{\Rollen}[1]{\ensuremath{\langle}#1\ensuremath{\rangle}}
\newcommand{\Qc}[1]{\texttt{#1}}
\newcommand{\acr}[1]{{#1}}
\newcommand{\ak}[1]{#1\marginpar{\textcolor{textblue}{\footnotesize #1}}}
\newcommand{\mar}[1]{\marginpar{\textcolor{textblue}{\footnotesize #1}}}
\newcommand{\zB}{z.\thinspace{}B.~}
\newcommand{\oA}{o.\thinspace{}ä.~}
\newcommand{\idR}{i.\,d.\,R.\ }
\newcommand{\BBel}[1]{\B[-5]{#1}}
\newcommand{\Bewegtes}[1]{\ensuremath{_{\textrm{#1}}}}
\newcommand{\ORi}{\Bewegtes{1}}
\newcommand{\ORii}{\Bewegtes{2}}
\newcommand{\ORiii}{\Bewegtes{3}}
\newcommand{\ORiv}{\Bewegtes{4}}
\newcommand{\ORv}{\Bewegtes{5}}
\newcommand{\Spur}[1]{t\Sub{#1}}
\newcommand{\Ti}{\Spur{1}}
\newcommand{\Tii}{\Spur{2}}
\newcommand{\Tiii}{\Spur{3}}
\newcommand{\Tiv}{\Spur{4}}
%\newcommand{\Akz}{\ensuremath{^\prime}}
\newcommand{\Akz}{\textipa{\textprimstress }}
\newcommand{\Nakz}{\textipa{\textsecstress }}
\newcommand{\Sgel}[1]{\textipa{\textsubdot{#1}}}
\newcommand{\PhPr}[1]{\ensuremath{\stackrel{\textnormal{#1\ }}{\Longrightarrow}}}
\newcommand{\phopro}{\ensuremath{\Rightarrow}}

\newcommand{\KTArr}[1]{\ding{226}~\textit{#1}~\ding{226}}
%\newcommand{\KTArr}[1]{\ensuremath{\underrightarrow{\mathrm{\scriptstyle~#1~~}}}}

\newcommand{\VfTest}{\KTArr{VfTest}~}
\newcommand{\PronTest}{\KTArr{PronTest}~}
\newcommand{\KoorTest}{\KTArr{KoorTest}~}
\newcommand{\onestar}{◆◇◇}
\newcommand{\twostar}{◆◆◇}
\newcommand{\tristar}{◆◆◆}
\newcommand{\RPr}{\ensuremath{\ll}}
\newcommand{\RUn}{\ensuremath{\sim}}
\newcommand{\REq}{\ensuremath{=}}
\newcommand{\Opsional}{★~}
\newcommand{\Nono}{---}
\newcommand{\Sub}[1]{\ensuremath{_{\text{#1}}}}
\newcommand{\Up}[1]{\ensuremath{^{\text{#1}}}}
\newcommand{\TuBegin}{\ding{217}}
\newcommand{\TuEnd}{}
\newcommand{\Folgt}{\ding{217}}

\newcommand*\circlearound[1]{\tikz[baseline=(char.base)]{\node[shape=circle,draw,inner sep=2pt] (char) {#1};}}

% xyling
\newcommand{\QQw}[1][-]{\POS[]+(-4,-1)-(4,4);\POS[]+(0,-1)+(8,4)**\frm{#1}}
\newcommand{\QQww}[1][-]{\POS[]+(-6,-1)-(6,4);\POS[]+(0,-1)+(12,4)**\frm{#1}}
\newcommand{\QQwww}[1][-]{\POS[]+(-8,-1)-(8,4);\POS[]+(0,-1)+(16,4)**\frm{#1}}
\newcommand{\QQwwww}[1][-]{\POS[]+(-10,-1)-(10,4);\POS[]+(0,-1)+(20,4)**\frm{#1}}
\newcommand{\BSd}[1]{\Bkk{-0.3,0}{-0.3,0}{#1}\Bkk{0.3,0}{0.3,0}{#1}}
\newcommand{\BLd}[1]{\B{#1}\Bkk{-3,0}{-3,0}{#1}}
\newcommand{\BRd}[1]{\B{#1}\Bkk{3,0}{3,0}{#1}}
\newcommand{\Bbeldash}[2][0]{\POS[]-(0,9)\POS+(0,#1)\ar@{--}[#2]+(0,2)}
\newcommand{\Bbel}[1]{\Bk{-4}{0}{#1}}



% boxes and stuff for definitions, axioms etc.
\definecolor{textblue}{rgb}{0,0,.5}
\definecolor{textred}{rgb}{.5,0,0}
\definecolor{textgreen}{rgb}{0,.5,0}
\definecolor{lightblue}{rgb}{.9,.9,1}
\definecolor{lightgreen}{rgb}{.9,1,.9}
\definecolor{lightred}{rgb}{1,.9,.9}
\definecolor{lightyellow}{rgb}{1,1,.8}
\definecolor{lightgray}{rgb}{.88,.88,.88}
\definecolor{lsLightgray}{gray}{0.88}
\definecolor{lsYellow}{cmyk}{0,0.25,1,0}


% bookkeeping of own environments for definitions etc.
\newlistof[chapter]{dgdef}{dgd}{Verzeichnis der Definitionen}
\newlistof[chapter]{dgsatz}{dgs}{Verzeichnis der Sätze}
\newlistof[chapter]{dgvertief}{dgv}{Verzeichnis der Vertiefungen}

\newcounter{deskgram-ziel}
\newcounter{deskgram-ex}
\newcounter{deskgram-strsch}
\newcounter{deskgram-wfilt}
\newcounter{deskgram-pholproz}


% Fix spacing between numbers and caption in list of figures etc.
\makeatletter
  \renewcommand*\l@figure{\@dottedtocline{1}{1em}{3.2em}}
  \renewcommand*\l@table{\@dottedtocline{1}{1em}{3.2em}}
  \renewcommand*\l@dgdef{\@dottedtocline{1}{1em}{3.2em}}
  \renewcommand*\l@dgsatz{\@dottedtocline{1}{1em}{3.2em}}
\makeatother


% NEW Vertiefung (non-floating)

\newcommand{\tblsthickline}{{\color{gray}\rule{\textwidth}{1.5mm}}}

\newenvironment{Sandwich}[1]
  {
    \par\vspace{5mm}\noindent\tblsthickline
    {\par\vspace{3mm}\noindent\sffamily\large\bfseries#1\vspace{4mm}}
  }
  {\par\vspace{3mm}\noindent\tblsthickline\par\vspace{5mm}}


\newenvironment{Vertiefung}[1]
  { 
    \refstepcounter{dgvertief}
    \begin{Sandwich}{#1\hfill Vertiefung~\thechapter.\arabic{dgvertief}}
  }
  {\end{Sandwich}}


% if not using hyperref, redefine this as empty:
\newcommand{\Phantom}{\phantomsection}


\newcommand{\Definition}[2]{
  \refstepcounter{dgdef}
  \tblscolorbox[report]{lsLightGray}{#1\hfill Definition~\thechapter.\arabic{dgdef}}{#2}
}



\newcommand{\Satz}[2]{
  \refstepcounter{dgsatz}
  \tblscolorbox[glass]{lsLightGray}{#1\hfill Definition~\thechapter.\arabic{dgdef}}{#2}
}



\newcommand{\Zusammenfassung}[1]{
  \tblsframebox[refresh]{lsYellow}{Zusammenfassung von Abschnitt~\thesection}{#1}
}



\newcommand{\WFiltTree}[7][5mm]{%
  \refstepcounter{deskgram-wfilt}
  \tblscolorbox[filter]{lsLightGray}{#2\hfill Wortklassenfilter~\arabic{deskgram-wfilt}}{
    \label{#3}
    \hspace{-5pt}\centering
    \begin{tikzpicture}[baseline]
    \node at (0,0) (Wort) [align=left] {#4};
    \node [right=of Wort.east, text width=3.5cm, align=left] (Filter) {#5};
    \node [above right=\baselineskip and 1cm of Filter.east] (Ja) {#6};
    \node [below right=\baselineskip and 1cm of Filter.east] (Nein) {#7}; 
    \path (Wort) edge [-{Latex[round]}] (Filter);
    \path (Filter.east) edge [-{Latex[round]}] node [above,sloped] {Ja} (Ja.west);
    \path (Filter.east) edge [-{Latex[round]}] node [below,sloped] {Nein} (Nein.west);
  \end{tikzpicture}\vspace{#1}%
  }{law}
}




\newcommand{\strschemspace}{\hspace{1em}}
\newcommand{\Phrasenschema}[2]{
  \refstepcounter{deskgram-strsch}
  \tblscolorbox[tree]{lsLightGray}{#1\hfill Phrasenschema~\arabic{deskgram-strsch}}{
    \vspace{-0.4cm}%
    \centering
    #2 \vspace{0.5cm}
  }
}



% OLD "further reading"
\newcommand{\WeitereLiteratur}[1]{
  \tblsframebox[book]{lsLightGray}{Weiterführende Literatur zu \thepart}{#1}
}


% Excercises.
\newcounter{Exer}[chapter]

\newcommand{\Uebung}[1][\twostar]{\par\medskip\refstepcounter{Exer}\noindent\textbf{Übung~\arabic{Exer}}~#1\ }

\newcommand{\Uebungen}{
  \clearpage
  \section*{Übungen zu Kapitel \thechapter}
  \markboth{Übungen zu Kapitel \thechapter}{Übungen zu Kapitel \thechapter}
  \setcounter{equation}{0}
}

\newcommand{\Loesungen}[2][\clearpage]{#1\section*{Zu Kapitel \ref{#2}}}
\newcommand{\Loesung}[1]{\subsection*{Übung \ref{#1}}}

\renewcommand{\Phantom}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Text used in several chapters %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\ThePhonStr}{
  \begin{forest}
    ake/.style={
      tier=terminal,
      delay={for children={content=\textipa{##1}}}
    }
    [Silbe, calign=last
      [Anfangsrand, ake, calign=first
	[f][K]
      ]
      [Reim, calign=first
	[Kern,ake
	  [E]
	]
	[Endrand, ake, calign=last
	  [m][t]
	]
      ]
    ]
  \end{forest}
}

\newcommand{\ThePhrasenExOne}{dass [[dem Jungen] [die Mutter] [ein Eis] [geschenkt hat]]}

\newcommand{\ThePhrasenExTwo}{dass [[ein Eis] [die Mutter] [dem Jungen] [geschenkt hat]]}


%%%%%%%%%%%%
%%% TikZ %%%
%%%%%%%%%%%%

% Undefining node names.

\makeatletter

\long\def\ifnodedefined#1#2#3{%
  \@ifundefined{pgf@sh@ns@#1}{#3}{#2}}

\newcommand\aeundefinenode[1]{%
  \expandafter\ifx\csname pgf@sh@ns@#1\endcsname\relax
  \else
    \typeout{===>Undefining node "#1"}%
    \global\expandafter\let\csname pgf@sh@ns@#1\endcsname\relax
  \fi
}

\newcommand\aeundefinethesenodes[1]{%
  \foreach \myn  in {#1}
    {%
      \ifnodedefined{\myn}{%
      \expandafter\aeundefinenode\expandafter{\myn}%
    }{}
    }%
}

\newcommand\aeundefinenumericnodes{%
  \foreach \myn in {1,2,...,20}
    {%
      \ifnodedefined{\myn}{%
      \expandafter\aeundefinenode\expandafter{\myn}%
    }{}
    }%
}


\makeatother

% Drawing sonority diagrams.

\newcommand{\plo}{0}
\newcommand{\fri}{0.5}
\newcommand{\nas}{1}
\newcommand{\liq}{1.5}
\newcommand{\vok}{2}

% Save text.
\newcommand{\lastsaved}{}
\newcommand{\textsave}[1]{\gdef\lastsaved{#1}#1}

\newcommand{\SonDiag}[2][0]{%
  \begin{tikzpicture}
    \textsave{.}
    \tikzset{
      tip/.style={execute at begin node=\tipaencoding},
      normalseg/.style={tip, fill=white},
      extrasyll/.style={tip, circle, draw, fill=white},
      sylljoint/.style={tip, diamond, draw, fill=white}
    }
    \node at (0,\plo) {P};
    \node at (0,\fri) {F};
    \node at (0,\nas) {N};
    \node at (0,\liq) {L};
    \node at (0,\vok) {V};

    % Draw the helper lines if required.
    \ifthenelse{\equal{#1}{0}}{}{%
      \foreach \y in {\plo, \fri, \nas, \liq,\vok} {%
	\draw [dotted, |-|] (0.25, \y) -- (#1.75, \y);
      }
    }

    \foreach [count=\x from 1, remember=\x as \lastx] \p / \y / \g in #2 {
      \ifthenelse{\equal{\y}{-1}}{\textsave{.}}{%

	% Draw the node, either plain, as Silbenbgelenk, or as extrasyllabic.
        \ifthenelse{\equal{\g}{1}}{%
	  \node (\x) [sylljoint] at (\x, \y) {\p};
	}{%
	  \ifthenelse{\equal{\g}{2}}{%
	    \node (\x) [extrasyll] at (\x, \y) {\p};
	  }{%
	    \node (\x) [normalseg] at (\x, \y) {\p};
	  }
	}

	% Draw the connection unless the previous node was not or was empty.
	\ifthenelse{\NOT\equal{\lastsaved}{.}}{%
	  \draw [->] (\lastx) to (\x);
	}{}
	\textsave{1}
      }
    }
    \aeundefinenumericnodes
  \end{tikzpicture}
}


